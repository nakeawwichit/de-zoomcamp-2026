id: question_3
namespace: zoomcamp.week2

tasks:
  - id: calculate_rows
    type: io.kestra.plugin.scripts.python.Script
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    containerImage: python:3.10-slim
    beforeCommands:
      - pip install requests
    script: |
      import requests
      import gzip
      import shutil
      import os

      total_rows = 0
      
      # Loop through months 01 to 12
      for month in range(1, 13):
          month_str = f"{month:02d}"
          url = f"https://github.com/DataTalksClub/nyc-tlc-data/releases/download/yellow/yellow_tripdata_2020-{month_str}.csv.gz"
          file_name = f"data_{month_str}.csv.gz"
          
          print(f"Downloading {url}...")
          
          try:
              with requests.get(url, stream=True) as r:
                  r.raise_for_status()
                  with open(file_name, 'wb') as f:
                      shutil.copyfileobj(r.raw, f)
              
              print(f"Counting rows for month {month_str}...")
              
              count = 0
              with gzip.open(file_name, 'rt', encoding='utf-8') as f:
                  for i, _ in enumerate(f):
                      count = i
              
              # count = index of last line. 
              # If file has header + 1 row (2 lines), indices are 0, 1. i=1. Data rows = 1.
              # If file has just header (1 line), index is 0. i=0. Data rows = 0.
              
              # Be careful: if file is empty, i is undefined.
              # But these CSVs have headers.
              
              print(f"Month {month_str}: {count} rows")
              total_rows += count
              
              # Clean up
              os.remove(file_name)
              
          except Exception as e:
              print(f"Error processing month {month_str}: {e}")

      print(f"TOTAL ROWS (Yellow 2020): {total_rows}")
