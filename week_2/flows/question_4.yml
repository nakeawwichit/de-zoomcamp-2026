id: question_4
namespace: zoomcamp.week2

tasks:
  - id: calculate_rows_green
    type: io.kestra.plugin.scripts.python.Script
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    containerImage: python:3.10-slim
    beforeCommands:
      - pip install requests
    script: |
      import requests
      import gzip
      import shutil
      import os

      total_rows = 0
      
      # Loop through months 01 to 12
      for month in range(1, 13):
          month_str = f"{month:02d}"
          url = f"https://github.com/DataTalksClub/nyc-tlc-data/releases/download/green/green_tripdata_2020-{month_str}.csv.gz"
          file_name = f"data_green_{month_str}.csv.gz"
          
          print(f"Downloading {url}...")
          
          try:
              with requests.get(url, stream=True) as r:
                  r.raise_for_status()
                  with open(file_name, 'wb') as f:
                      shutil.copyfileobj(r.raw, f)
              
              print(f"Counting rows for month {month_str}...")
              
              count = 0
              with gzip.open(file_name, 'rt', encoding='utf-8') as f:
                  for i, _ in enumerate(f):
                      count = i
              
              # count = index of last line (since enumerate starts at 0). 
              # For a file with Header + N data rows, the last index is N.
              # So if i=N, it means there are N data rows (excluding header).
              # Example: Header, Row1 -> i=0 (Header), i=1 (Row1). count=1. Correct.
              
              print(f"Month {month_str}: {count} rows")
              total_rows += count
              
              # Clean up
              os.remove(file_name)
              
          except Exception as e:
              print(f"Error processing month {month_str}: {e}")

      print(f"TOTAL ROWS (Green 2020): {total_rows}")
